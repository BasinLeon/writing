---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('literary', ({ data }) => !data.isDraft);
  return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const base = import.meta.env.BASE_URL;
const words = entry.body.trim().split(/\s+/).filter(Boolean).length;
const readMinutes = Math.max(1, Math.round(words / 220));
const toSlug = (value: string) => value.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
const seriesName = entry.data.series?.trim() ?? '';
const isSeries = !!seriesName;
let seriesPosts: typeof entry[] = [];

if (isSeries) {
  const allPublished = await getCollection('literary', ({ data }) => data.isDraft !== true);
  seriesPosts = allPublished
    .filter((post) => (post.data.series?.trim() ?? '') === seriesName)
    .sort((a, b) => a.data.publishDate.valueOf() - b.data.publishDate.valueOf());
}
---

<Layout
  title={`${entry.data.title} | Leon Basin Literary`}
  description={entry.data.description}
  type="article"
  publishDate={entry.data.publishDate}
  readingMode={true}
  hideGlobalHeader={true}
  hideGlobalColophon={true}
>
  <nav class="reader-nav">
    <a href={base}>← Index</a>
  </nav>

  <article class="reader-environment">
    <header class="prose-header">
      <h1 class="prose-title">{entry.data.title}</h1>
      <div class="prose-meta">
        <time datetime={entry.data.publishDate.toISOString()}>
          {entry.data.publishDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
        </time>
        {' • '}
        <span>{entry.data.type}</span>
        {' • '}
        <span>{readMinutes} min read</span>
      </div>
      <div class="taxonomy-line">
        {entry.data.series && <a href={`${base}series/${toSlug(entry.data.series)}/`}>Series: {entry.data.series}</a>}
        {(entry.data.tags ?? []).map((tag) => (
          <a href={`${base}tags/${toSlug(tag)}/`}>#{tag}</a>
        ))}
      </div>
      {isSeries && seriesPosts.length > 1 && (
        <aside class="series-toc" aria-label={`${seriesName} table of contents`}>
          <p class="toc-label">Volume Index - <strong>{seriesName}</strong></p>
          <ol class="toc-list">
            {seriesPosts.map((post, index) => (
              <li>
                {post.slug === entry.slug ? (
                  <span class="toc-current">Part {index + 1}. {post.data.title}</span>
                ) : (
                  <a href={`${base}literary/${post.slug}/`} class="toc-link">
                    Part {index + 1}. {post.data.title}
                  </a>
                )}
              </li>
            ))}
          </ol>
        </aside>
      )}
    </header>

    <div class="prose-content">
      <Content />
    </div>
  </article>
</Layout>

<style is:global>
  .reader-nav {
    max-width: 65ch;
    margin-inline: auto;
    padding-inline: 1.5rem;
    padding-top: 2rem;
  }

  .reader-nav a {
    text-decoration: none;
    color: var(--warm-ivory);
    opacity: 0.5;
    font-size: 0.9rem;
    transition: opacity 0.2s ease;
  }

  .reader-nav a:hover {
    opacity: 1;
  }

  .reader-environment {
    max-width: 100%;
    padding-inline: clamp(1.5rem, 5vw, 3rem);
    padding-bottom: 15vh;
    margin-inline: auto;
  }

  .prose-header {
    margin-top: 10vh;
    margin-bottom: 4rem;
    text-align: center;
  }

  .prose-title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 3vw + 1rem, 3.5rem);
    line-height: 1.1;
    color: var(--light-soft-gold);
    margin-bottom: 1rem;
    text-wrap: balance;
    letter-spacing: -0.02em;
  }

  .prose-meta {
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.6;
  }

  .taxonomy-line {
    margin-top: 0.8rem;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.8rem;
    font-size: 0.8em;
  }

  .taxonomy-line a {
    color: var(--warm-ivory);
    opacity: 0.75;
    text-decoration: underline;
    text-decoration-color: rgba(224, 185, 115, 0.55);
    text-underline-offset: 0.16em;
  }

  .taxonomy-line a:hover {
    opacity: 1;
  }

  .series-toc {
    max-width: 65ch;
    margin-inline: auto;
    margin-bottom: 4rem;
    padding: 1.5rem 2rem;
    background-color: rgba(237, 231, 218, 0.02);
    border-left: 2px solid var(--light-soft-gold);
    font-family: var(--font-primary);
    text-align: left;
  }

  .toc-label {
    margin: 0 0 1rem;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.5;
  }

  .toc-label strong {
    color: var(--light-soft-gold);
    font-family: var(--font-display);
    letter-spacing: normal;
    text-transform: none;
    font-size: 1.1rem;
    margin-left: 0.5rem;
  }

  .toc-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .toc-link {
    color: var(--warm-ivory);
    text-decoration: none;
    opacity: 0.7;
    transition: opacity 0.2s ease, color 0.2s ease;
  }

  .toc-link:hover {
    opacity: 1;
    color: var(--light-soft-gold);
  }

  .toc-current {
    color: var(--warm-ivory);
    font-style: italic;
    opacity: 1;
    position: relative;
    padding-left: 1.2rem;
  }

  .toc-current::before {
    content: "->";
    position: absolute;
    left: 0;
    color: var(--light-soft-gold);
  }

  .prose-content {
    max-width: 65ch;
    margin-inline: auto;
    font-size: clamp(1.125rem, 1vw + 1rem, 1.3rem);
    line-height: 1.7;
    color: var(--warm-ivory);
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .prose-content p {
    margin-bottom: 1.75em;
    text-wrap: pretty;
  }

  .prose-content h2,
  .prose-content h3 {
    font-family: var(--font-display);
    color: var(--light-soft-gold);
    line-height: 1.2;
    margin-top: 3em;
    margin-bottom: 1em;
    text-wrap: balance;
  }

  .prose-content > p:first-of-type::first-letter {
    float: left;
    font-size: 4.5em;
    line-height: 0.8;
    margin-right: 0.15em;
    margin-top: 0.05em;
    font-family: var(--font-display);
    color: var(--light-soft-gold);
  }

  .prose-content blockquote {
    margin-inline: 0;
    padding-left: 1.5rem;
    border-left: 1px solid var(--light-soft-gold);
    font-style: italic;
    opacity: 0.85;
  }

  .prose-content hr {
    border: none;
    text-align: center;
    margin-block: 4rem;
  }

  .prose-content hr::before {
    content: "***";
    color: var(--light-soft-gold);
    letter-spacing: 0.5em;
    opacity: 0.5;
  }

  .prose-content a {
    color: inherit;
    text-decoration: underline;
    text-decoration-color: rgba(224, 185, 115, 0.65);
    text-underline-offset: 0.14em;
  }

  @media (max-width: 640px) {
    .reader-nav {
      padding-inline: 1rem;
      padding-top: 1.2rem;
    }

    .prose-header {
      margin-top: 6vh;
      margin-bottom: 2.5rem;
    }

    .series-toc {
      padding: 1rem 1.2rem;
    }
  }
</style>
