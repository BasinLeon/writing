---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('literary', ({ data }) => !data.isDraft);
  return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const base = import.meta.env.BASE_URL;
const words = entry.body.trim().split(/\s+/).filter(Boolean).length;
const readMinutes = Math.max(1, Math.round(words / 220));
const toSlug = (value: string) => value.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
---

<Layout
  title={`${entry.data.title} | Leon Basin Literary`}
  description={entry.data.description}
  readingMode={true}
  hideGlobalHeader={true}
  hideGlobalColophon={true}
>
  <nav class="reader-nav">
    <a href={base}>← Index</a>
  </nav>

  <article class="reader-environment">
    <header class="prose-header">
      <h1 class="prose-title">{entry.data.title}</h1>
      <div class="prose-meta">
        <time datetime={entry.data.publishDate.toISOString()}>
          {entry.data.publishDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
        </time>
        {' • '}
        <span>{entry.data.type}</span>
        {' • '}
        <span>{readMinutes} min read</span>
      </div>
      <div class="taxonomy-line">
        {entry.data.series && <a href={`${base}series/${toSlug(entry.data.series)}/`}>Series: {entry.data.series}</a>}
        {(entry.data.tags ?? []).map((tag) => (
          <a href={`${base}tags/${toSlug(tag)}/`}>#{tag}</a>
        ))}
      </div>
    </header>

    <div class="prose-content">
      <Content />
    </div>
  </article>
</Layout>

<style is:global>
  .reader-nav {
    max-width: 65ch;
    margin-inline: auto;
    padding-inline: 1.5rem;
    padding-top: 2rem;
  }

  .reader-nav a {
    text-decoration: none;
    color: var(--warm-ivory);
    opacity: 0.5;
    font-size: 0.9rem;
    transition: opacity 0.2s ease;
  }

  .reader-nav a:hover {
    opacity: 1;
  }

  .reader-environment {
    font-size: clamp(1.125rem, 1vw + 1rem, 1.375rem);
    line-height: 1.65;
    max-width: 65ch;
    padding-inline: clamp(1.5rem, 5vw, 3rem);
    padding-bottom: 15vh;
    margin-inline: auto;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .prose-header {
    margin-top: 10vh;
    margin-bottom: 4rem;
    text-align: center;
  }

  .prose-title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 3vw + 1rem, 3.5rem);
    line-height: 1.1;
    color: var(--light-soft-gold);
    margin-bottom: 1rem;
    text-wrap: balance;
    letter-spacing: -0.02em;
  }

  .prose-meta {
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.6;
  }

  .taxonomy-line {
    margin-top: 0.8rem;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.8rem;
    font-size: 0.8em;
  }

  .taxonomy-line a {
    color: var(--warm-ivory);
    opacity: 0.75;
    text-decoration: underline;
    text-decoration-color: rgba(224, 185, 115, 0.55);
    text-underline-offset: 0.16em;
  }

  .taxonomy-line a:hover {
    opacity: 1;
  }

  .prose-content p {
    margin-bottom: 1.75em;
    text-wrap: pretty;
  }

  .prose-content blockquote {
    margin-inline: 0;
    padding-left: 1.5rem;
    border-left: 2px solid var(--light-soft-gold);
    font-style: italic;
    opacity: 0.85;
  }

  .prose-content hr {
    border: none;
    text-align: center;
    margin-block: 4rem;
  }

  .prose-content hr::before {
    content: "***";
    color: var(--light-soft-gold);
    letter-spacing: 0.5em;
    opacity: 0.5;
  }

  .prose-content a {
    color: inherit;
    text-decoration: underline;
    text-decoration-color: rgba(224, 185, 115, 0.65);
    text-underline-offset: 0.14em;
  }

  @media (max-width: 640px) {
    .reader-nav {
      padding-inline: 1rem;
      padding-top: 1.2rem;
    }

    .prose-header {
      margin-top: 6vh;
      margin-bottom: 2.5rem;
    }
  }
</style>
