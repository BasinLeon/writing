---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('literary', ({ data }) => !data.isDraft);
  return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const base = import.meta.env.BASE_URL;
const words = entry.body.trim().split(/\s+/).filter(Boolean).length;
const readMinutes = Math.max(1, Math.round(words / 220));

const all = (await getCollection('literary', ({ data }) => !data.isDraft))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());
const currentIndex = all.findIndex((x) => x.slug === entry.slug);
const next = currentIndex > -1 ? all[currentIndex + 1] : undefined;
const prev = currentIndex > 0 ? all[currentIndex - 1] : undefined;
---

<Layout title={`${entry.data.title} | Leon Basin Literary`} description={entry.data.description} readingMode={entry.data.readingMode}>
  <article class="essay-layout">
    <header class="essay-head">
      <p class="kicker">{entry.data.series}</p>
      <h1>{entry.data.title}</h1>
      <p class="essay-meta">
        {entry.data.publishDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
        {' • '}
        {entry.data.type}
        {' • '}
        {readMinutes} min read
      </p>
    </header>

    <div class="essay-grid">
      <aside class="toc">
        <p>On This Page</p>
        <nav>
          {headings
            .filter((h) => h.depth === 2 || h.depth === 3)
            .map((h) => (
              <a href={`#${h.slug}`} style={h.depth === 3 ? 'padding-left: 0.65rem;' : ''}>{h.text}</a>
            ))}
        </nav>
      </aside>

      <section class="essay-content prose">
        <Content />
      </section>
    </div>

    <footer class="endmatter">
      <h2>Continue Reading</h2>
      <div class="endmatter-links">
        <a href={`${base}literary/`}>Back to Literary Lane</a>
        {prev && <a href={`${base}literary/${prev.slug}/`}>Previous: {prev.data.title}</a>}
        {next && <a href={`${base}literary/${next.slug}/`}>Next: {next.data.title}</a>}
      </div>
    </footer>
  </article>
</Layout>
