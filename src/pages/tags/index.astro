---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const literary = await getCollection('literary', ({ data }) => !data.isDraft);
const toSlug = (value: string) => value.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');

const tagCounts = literary.reduce((acc, entry) => {
  for (const tag of entry.data.tags ?? []) {
    const clean = tag.trim();
    if (!clean) continue;
    acc.set(clean, (acc.get(clean) ?? 0) + 1);
  }
  return acc;
}, new Map<string, number>());

const tags = Array.from(tagCounts.entries())
  .map(([name, count]) => ({ name, count, slug: toSlug(name) }))
  .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));

const base = import.meta.env.BASE_URL;
---

<Layout title="Tags | Leon Basin Literary" description="Archive grouped by thematic tags.">
  <section class="latest">
    <p class="kicker">Catalog</p>
    <h1>Tags</h1>
    <ol class="writing-list">
      {tags.map((item) => (
        <li>
          <a class="writing-title" href={`${base}tags/${item.slug}/`}>{item.name}</a>
          <p class="writing-meta">{item.count} piece{item.count === 1 ? '' : 's'} â€¢ tag</p>
        </li>
      ))}
    </ol>
  </section>
</Layout>
