---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const toSlug = (value: string) => value.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');

export async function getStaticPaths() {
  const allWriting = await getCollection('literary', ({ data }) => data.isDraft !== true);
  const allSeries = [...new Set(allWriting.map((post) => post.data.series?.trim()).filter(Boolean))] as string[];

  return allSeries.map((seriesName) => {
    const posts = allWriting
      .filter((post) => (post.data.series?.trim() ?? '') === seriesName)
      .sort((a, b) => a.data.publishDate.valueOf() - b.data.publishDate.valueOf());

    return {
      params: { series: toSlug(seriesName) },
      props: { seriesName, posts }
    };
  });
}

const { seriesName, posts } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<Layout title={`${seriesName} | Leon Basin Literary`} description={`Series archive for ${seriesName}.`}>
  <nav class="reader-nav">
    <a href={base}>‚Üê Index</a>
  </nav>

  <main class="series-ledger">
    <header class="series-header">
      <h1 class="display-title">{seriesName}</h1>
      <p class="series-meta">{posts.length} {posts.length === 1 ? 'Entry' : 'Entries'}</p>
    </header>

    <ol class="archive-list">
      {posts.map((post, index) => (
        <li>
          <span class="ledger-chapter">Part {index + 1}</span>
          <a href={`${base}literary/${post.slug}/`} class="ledger-link">{post.data.title}</a>
          <time datetime={post.data.publishDate.toISOString()} class="ledger-date">
            {post.data.publishDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
          </time>
        </li>
      ))}
    </ol>
  </main>
</Layout>

<style>
  .reader-nav {
    max-width: 65ch;
    margin-inline: auto;
    padding-inline: 1.5rem;
    padding-top: 2rem;
  }

  .reader-nav a {
    text-decoration: none;
    color: var(--warm-ivory);
    opacity: 0.5;
    font-size: 0.9rem;
  }

  .reader-nav a:hover {
    opacity: 1;
  }

  .series-ledger {
    max-width: 65ch;
    margin-inline: auto;
    padding-inline: 1.5rem;
    padding-top: 2.4rem;
    padding-bottom: 5rem;
  }

  .series-header {
    margin-bottom: 2.4rem;
    border-bottom: 1px solid rgba(224, 185, 115, 0.34);
    padding-bottom: 1rem;
  }

  .display-title {
    font-family: var(--font-display);
    font-size: clamp(1.9rem, 4vw, 2.5rem);
    color: var(--warm-ivory);
    margin: 0 0 0.35rem;
    line-height: 1.08;
  }

  .series-meta {
    margin: 0;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.62;
  }

  .archive-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .archive-list li {
    display: grid;
    grid-template-columns: 80px 1fr 100px;
    gap: 1rem;
    align-items: baseline;
    padding-block: 1rem;
    border-bottom: 1px solid rgba(237, 231, 218, 0.08);
  }

  .ledger-chapter {
    font-size: 0.82rem;
    opacity: 0.56;
    font-family: var(--font-display);
  }

  .ledger-link {
    text-decoration: none;
    color: var(--warm-ivory);
    font-size: 1.08rem;
    line-height: 1.2;
  }

  .ledger-link:hover {
    color: var(--light-soft-gold);
  }

  .ledger-date {
    font-size: 0.85rem;
    opacity: 0.54;
    text-align: right;
  }

  @media (max-width: 700px) {
    .series-ledger {
      padding-inline: 1rem;
    }

    .archive-list li {
      grid-template-columns: 1fr;
      gap: 0.3rem;
    }

    .ledger-date {
      text-align: left;
    }
  }
</style>
